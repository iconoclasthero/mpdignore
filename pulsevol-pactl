#!/bin/bash

defaultpulse=127.0.0.1
. ~/.config/mpd-local.conf

gigabyte=192.168.1.2
optiplex=192.168.12.222
compaq=192.168.12.22

scriptname=$(realpath "$0")
. /usr/local/bin/editscript

notifier(){
    local state="$1"
    (( verbose )) && printf '$state=%s\n' "$state"
    notify-send -a "pactl" -i audio-x-generic "$state"
}

volstatus(){
    volout="$(ssh "$ip" pactl list sinks | awk -v sid="$sink" '
        $1=="Sink" && $2==sid {found=1}
        found && /Volume:/ {
            sub(/,/, "", $5); sub(/,/, "", $8)
            if($5!=$8) printf "Volume: Left %s%% â€” Right %s%%", $5, $8
            else printf "Volume: %s%%", $5
        }'
    )"
    muteout="$(ssh "$ip" pactl list sinks | awk -v sid="$sink" '
        $1=="Sink" && $2==sid {found=1}
        found && /Mute:/ {print " Muted:", ($2=="yes"?"yes":"no")}'
    )"
}

checktcpmodule(){
    checktcp="$(ssh "$ip" pactl list short modules | grep module-native-protocol-tcp)"
    checktcperr="$?"
    (( checktcperr != 0 )) && ssh "$ip" pactl unload-module module-native-protocol-tcp >/dev/null 2>&1
    (( checktcperr != 0 )) && ssh "$ip" pactl load-module module-native-protocol-tcp auth-ip-acl='127.0.0.1\;192.168.0.0/16' auth-anonymous=1
    (( checktcperr == 0 )) && echo "Module loaded: $checktcp"
}

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --compaq) ip="$compaq"; shift ;;
        --optiplex|--opti) ip="$optiplex"; shift ;;
        --gig|--gigabyte) ip="$gigabyte"; shift ;;
        --mute|--toggle-mute|mute) cmd="--toggle-mute"; shift ;;
        --sink) sink="$2"; shift 2 ;;
        --mixer) cmd='mixer'; shift ;;
        *)
            if [[ "$1" =~ ^(-|\+)?[0-9]{1,3}$ ]]; then
                if [[ "$1" =~ ^[0-9]+$ ]]; then
                    cmd="--set-volume=$1"
                else
                    cmd="--change-volume=$1"
                fi
            else
                echo "Unknown parameter: $1"
                exit 1
            fi
            shift
            ;;
    esac
done

: "${ip:="$defaultpulse"}"
: "${sinkname:="$defsinkname"}"

if [[ -z "$sink" ]]; then
    mapfile -t sinks < <(ssh "$ip" pactl list sinks short | awk -v name="$defsinkname" '$2 ~ name {print $1}')
    if (( ${#sinks[@]} == 0 )); then
        echo "Error: no sink matches '$defsinkname'" >&2
        exit 1
    elif (( ${#sinks[@]} > 1 )); then
        echo "Error: multiple sinks match '$defsinkname': ${sinks[*]}" >&2
        exit 1
    else
        sink="${sinks[0]}"
    fi
fi

(( verbose )) && read -rp "[verbose] \$sink=$sink"

if [[ "$cmd" = 'mixer' ]]; then
    ssh "$ip" pactl list sinks
elif [[ "$cmd == --toggle-mute" ]]; then
    ssh "$ip" pactl set-sink-mute "$sink" toggle
elif [[ "$cmd" == --set-volume=* ]]; then
    vol="${cmd#*=}"
    ssh "$ip" pactl set-sink-volume "$sink" "$vol%"
elif [[ "$cmd" == --change-volume=* ]]; then
    vol="${cmd#*=}"
    ssh "$ip" pactl set-sink-volume "$sink" "$vol%"
else
    printf '\nNo volume command provided.\n\nUsage: %s --compaq|--gig|--mute|<volume_change>\n\n' "$0"
    printf 'Current sink status:\n'
    volstatus
    printf '  %s\n  %s\n' "$volout" "$muteout"

    printf '\nAvailable sinks:\n'
    ssh "$ip" pactl list sinks short | awk '{printf "- ID: %s | Name: %s\n", $1, $2}'
fi

if (( notify )); then
    volstatus
    [[ "$cmd" == "--toggle-mute" ]] && notifier "$volout \n $muteout"
fi
