#!/bin/bash
# nb: the swp wfile that editscript relies on is provided by nano
debug=0
MPDSOCK="/var/run/mpd/socket"
shopt -s extglob
songdir=\/library\/music\/$(dirname "$(\mpc current -f %file%)")
songdir="/library/music/$(dirname "$(\mpc current -f %file%)")"
cover=( "${songdir}/"@(c|C)over.@(png|jpg|gif) )
shopt -u extglob
mpdlog="/var/log/mpd/mpd.log"
tmplog="/tmp/mpdtmp.log"
mpdlogfile=( "$mpdlog" )

mpdssepidfile="/tmp/mpdsse.pid"
mpdssepy="/var/www/cgi-bin/mpdsse.py"
mpdsseurl="127.0.0.1"
mpdsseport="5000"
mpdsselog="$tmplog"

(( debug )) && { date -Is; printf 'Starting %s\n' "$(realpath "$0")"; } >> "$tmplog"

startmpdsse(){  # flask launcher
  local notfound psauxout
  mpdssepid=0
  (( debug )) && printf '\nentering %s\n' "$FUNCNAME" >> "$mpdsselog"
  if [[ -f "$mpdssepidfile" ]]; then
    mpdssepid=$(<"$mpdssepidfile")
    (( mpdssepid && debug )) && printf 'Found %s\n$mpdssepid=%s\n' "$mpdssepidfile" "$mpdssepid" >> "$mpdsselog"
    (( debug )) && { printf 'Contents of %s:\n' "$mpdssepidfile"; cat "$mpdssepidfile"; } >> "$mpdsselog"
  else
    notfound=1
    (( debug )) && printf '%s not found\n' "$mpdssepidfile" >> "$mpdsselog"
  fi


  ! (( "$mpdssepid" )) || [[ -d "/proc/$mpdssepid" ]] && notfound=1
    (( debug )) && ! kill -0 "$mpdssepid" >> "$mpdsselog" 2>&1 && notfound=1
  ! (( debug )) && ! kill -0 "$mpdssepid" > /dev/null 2>&1 && notfound=1

  if (( notfound )); then
    psauxout=( $(ps aux|grep "[m]pdsse.py"|awk '{print $2}') )
    for i in "${psauxout[@]}"; do
      ! (( debug )) && { curl -sf http://"$mpdsseurl:$mpdsseport"/health > /dev/null; ec="$?" ; }
        (( debug )) && { curl http://"$mpdsseurl:$mpdsseport"/debug >> "$mpdsselog" 2>&1; ec="$?"; }
      if ! (( ec )); then
        notfound=0
        mpdssepid="$i"
        printf '%s\n' "$mpdssepid" > "$mpdssepidfile"
        (( debug )) && printf '\n$notfound=%s\n' "$notfound" >> "$mpdsselog"
        (( debug )) && printf '\n$mpdssepid=%s\n' "$mpdssepid" >> "$mpdsselog"
        return
        break
      fi
    done
  fi

  if (( notfound )); then
    ! (( debug )) && {
     gunicorn --bind 0.0.0.0:"$mpdsseport" --workers 1 --threads 2 --timeout 65 mpdsse:app > /dev/null 2>&1; } &
      (( debug )) && {
     gunicorn --bind 0.0.0.0:"$mpdsseport" 5000 --workers 1 --threads 2 --timeout 65 mpdsse:app  >> "$mpdsselog" 2>&1; } &
    mpdssepid="$!"
    printf %s\\n "$mpdssepid" > "$mpdssepidfile"
    (( debug )) && printf '$mpdssepid=%s\n' "$mpdssepid" >> "$mpdssepid"
    notfound=0
  fi
  (( debug )) && printf 'leaving %s\n' "$FUNCNAME" >> "$mpdsselog"
}
# flask launcher
##--> startmpdsse() <--################################################################################


startmpdsse(){  #original gunicorn launcher
  local notfound psauxout
  mpdssepid=0
  (( debug )) && printf '\nentering %s\n' "$FUNCNAME" >> "$mpdsselog"
  if [[ -f "$mpdssepidfile" ]]; then
    mpdssepid=$(<"$mpdssepidfile")
    (( mpdssepid && debug )) && printf 'Found %s\n$mpdssepid=%s\n' "$mpdssepidfile" "$mpdssepid" >> "$mpdsselog"
    (( debug )) && { printf 'Contents of %s:\n' "$mpdssepidfile"; cat "$mpdssepidfile"; } >> "$mpdsselog"
  else
    notfound=1
    (( debug )) && printf '%s not found\n' "$mpdssepidfile" >> "$mpdsselog"
  fi


  ! (( "$mpdssepid" )) || [[ -d "/proc/$mpdssepid" ]] && notfound=1
    (( debug )) && ! kill -0 "$mpdssepid" >> "$mpdsselog" 2>&1 && notfound=1
  ! (( debug )) && ! kill -0 "$mpdssepid" > /dev/null 2>&1 && notfound=1

  if (( notfound )); then
    psauxout=( $(ps aux|grep "[m]pdsse:app"|awk '{print $2}') )
    for i in "${psauxout[@]}"; do
         curl -sf http://"$mpdsseurl:$mpdsseport"/health > /dev/null; ec="$?"
#      ! (( debug )) && { curl -sf http://"$mpdsseurl:$mpdsseport"/health > /dev/null; ec="$?" ; }
#        (( debug )) && { curl http://"$mpdsseurl:$mpdsseport"/debug >> "$mpdsselog" 2>&1; ec="$?"; }
      if ! (( ec )); then
        notfound=0
        mpdssepid="$i"
        printf '%s\n' "$mpdssepid" > "$mpdssepidfile"
        (( debug )) && printf '\n$notfound=%s\n' "$notfound" >> "$mpdsselog"
        (( debug )) && printf '\n$mpdssepid=%s\n' "$mpdssepid" >> "$mpdsselog"
        return
        break
      fi
    done
  fi

  if (( notfound )); then
      pkill -9 gunicorn
      nohup gunicorn --bind 127.0.0.1:5000 \
                     --workers 1  \
                     --worker-class gthread \
                     --threads 4 \
                     --timeout 0 \
                     --graceful-timeout 0 \
                     --keep-alive 65 \
                     --log-level info
                     mpdsse:app >>  "$mpdsselog" 2>&1 &

#    ! (( debug )) && {
#     gunicorn --bind 0.0.0.0:"$mpdsseport" --workers 1 --threads 2 --timeout 65 mpdsse:app > /dev/null 2>&1; } &
#      (( debug )) && {
#     gunicorn --bind 0.0.0.0:"$mpdsseport" 5000 --workers 1 --threads 2 --timeout 65 mpdsse:app  >> "$mpdsselog" 2>&1; } &
    mpdssepid="$!"
    printf %s\\n "$mpdssepid" > "$mpdssepidfile"
    (( debug )) && printf '$mpdssepid=%s\n' "$mpdssepid" >> "$mpdssepid"
    notfound=0
  fi
  (( debug )) && printf 'leaving %s\n' "$FUNCNAME" >> "$mpdsselog"
}
## original gunicorn launcher
##--> startmpdsse() <--#######################################################################

startmpdsse() {
  debug=1
  local notfound psauxout mpdssepids ec curlcmd nullorlog pid gunicorncmd
  (( debug )) && nullorlog="$mpdsselog"
  : "${mpdsselog:=/tmp/mpdsse.log}"
  : "${nullorlog:=/dev/null}"

  (( debug )) && printf '\nentering %s\n' "$FUNCNAME" >> "$mpdsselog"
  # -------------------------------------------------
  # gunicorn profiles
  # -------------------------------------------------
  gdefault=(
    gunicorn
    --bind "127.0.0.1:$mpdsseport"
    --workers 1
    --threads 2
    --timeout 65
    mpdsse:app
  )

  gthread=(
    gunicorn
    --bind "127.0.0.1:$mpdsseport"
    --workers 1
    --worker-class gthread
    --threads 4
    --timeout 0
    --graceful-timeout 0
    --keep-alive 65
    --log-level info
    mpdsse:app
  )

  gevent=(
    gunicorn
    --bind "127.0.0.1:$mpdsseport"
    --workers 2
    --threads 4
    --timeout 90
    --graceful-timeout 30
    --keep-alive 75
    --log-level warning
    mpdsse:app
  )

  # -------------------------------------------------
  # choose profile
  # -------------------------------------------------
  # gunicorncmd=( "${gCdefault[@]}" )
    gunicorncmd=( "${gthread[@]}" )
  # gunicorncmd=( "${gevent[@]}" )

  # -------------------------------------------------
  # verify existing pid
  # -------------------------------------------------

  if [[ -f "$mpdssepidfile" ]]; then
    mpdssepids=( $(<"$mpdssepidfile") )
    (( debug )) && printf 'Found pidfile: %s \n  pid(s): %s\n\n' \
                     "$mpdssepidfile" "${mpdssepids[*]}" >> "$mpdsselog"
  else
    notfound=1
    (( debug )) && printf 'No pid file found: %s\n' "$mpdssepidfile" >> "$mpdsselog"
  fi

  readarray -t psauxout < <(ps aux | grep [g]unicorn | grep mpdsse:app | awk '{print $2}')

  readarray -t mpdssepids < <(printf %s\\n "${mpdssepids[@]}" "${psauxout[@]}"|sort -u)

  (( debug )) && printf 'psauxout: %s\n' "${psauxout[@]}" >> "$mpdsselog"
  (( debug )) && printf 'mpdssepids: %s\n' "${mpdssepids[@]}" >> "$mpdsselog"

  for i in "${!mpdssepids[@]}"; do
    [[ "${mpdssepids[i]}" =~ ^[0-9]+$ ]] && kill -0 "${mpdssepids[i]}" 2>>"$nullorlog" ||
      { (( debug )) && printf 'Unset PID %s (not found)\n' "${mpdssepids[i]}" >> "$mpdssetmp"; unset mpdssepids[i]; }
  done

  (( "${#mpdssepids[@]}" )) || notfound=1
  printf %s\\n "${mpdssepids[@]}" > "$mpdssepidfile"

  # -------------------------------------------------
  # http health check
  # -------------------------------------------------
  (( debug )) && curlcmd=( curl --verbose ) || curlcmd=( curl --silent )
  curlcmd+=( --connect-timeout 1  --max-time 6 --fail "$mpdsseurl:$mpdsseport/health" )

  (( debug )) && printf 'curlcmd: %s\n' "${curlcmd[*]}" >> "$mpdsselog"

  if (( debug )) && "${curlcmd[@]}" >> "$mpdsselog" 2>&1; then
    notfound=0
    printf 'curl to http://%s:%s/health suceeded\n' "$mpdsseurl" "$mpdsseport" >> "$mpdsselog"
    printf '%s\n' "${mpdssepids[@]}" > "$mpdssepidfile"
    printf '%s\n' "${mpdssepids[@]}" >> "$mpdsselog"
    printf 'Using existing pids %s\n' "${mpdssepids[@]}" >> "$mpdsselog"
  elif "${curlcmd[@]}" > /dev/null 2>&1; then
    notfound=0
    printf '%s\n' "${mpdssepids[@]}" > "$mpdssepidfile"
  elif (( "${#mpdssepids[@]}" )); then
    notfound=1
    # kill any stale validated PIDs
    (( debug )) && printf 'Health check failed; restarting mpdsse\n' >>"$mpdsselog"
    (( debug )) && printf 'Killing stale pids: %s\n' "${mpdssepids[@]}" >> "$mpdsselog"
    for pid in "${mpdssepids[@]}"; do
        kill -9 "$pid" 2>>"$nullorlog" || (( debug )) && printf 'Error kill -9 %s\n' "$pid" >> "$mpdsselog"
    done
    pkill -f "gunicorn.*mpdsse:app" 2>/dev/null
    sleep 1 s
  elif (( debug )); then
    printf 'Health check failed; restarting mpdsse\n' >>"$mpdsselog"
    printf 'curl failed; no pids remain, pkill -f "gunicorn.*mpdsse:app" \n' >> "$mpdsselog"
    pkill -f "gunicorn.*mpdsse:app" >> "$mpdsselog" 2>&1
    notfound=1
  else
    pkill -f "gunicorn.*mpdsse:app" 2>/dev/null
    notfound=1
  fi


  # -------------------------------------------------
  # launch new instance if not found
  # -------------------------------------------------
  if (( notfound )); then
      (( debug )) && printf 'starting new gunicorn: %s\n' "${gunicorncmd[*]}" >> "$nullorlog"
      "${gunicorncmd[@]}" >> "$nullorlog" 2>&1 &

   ## shouldn't we give this a sleep 2s; and then get the pids from psaux?
    sleep 1
    # collect PIDs for recording
    readarray -t mpdssepids < <(ps aux | grep [g]unicorn | grep mpdsse:app | awk '{print $2}')
    printf '%s\n' "${mpdssepids[@]}" > "$mpdssepidfile"
    (( debug )) && printf 'New PIDs: %s\n' "${mpdssepids[*]}" >> "$mpdsselog"
  fi

  (( debug )) && { printf '%s: return 0\n' "$FUNCNAME" >> "$mpdsselog"; return 0; }
}


##--> startmpdsse() <--#############################################################################

editscript(){
  local scriptpath script path swp; scriptpath=$(realpath "$0" 2>/dev/null); script="${scriptpath##*/}"; path="${scriptpath%/*}"; swp="$path/.$script.swp"
     [[ ! -e "$swp" ]] && printf "\n\n%s\n\n" "$swp" && (/usr/bin/nano "$scriptpath") && exit
     printf "\n%s is already being edited.\n%s exists; try fg or look in another window.\n" "$scriptpath" "$swp"; exit ;}

pause(){ read -rp "$*" < /dev/tty; }


mpdc() {
    ! "$MPDSOCK" && MPDSOCK="/var/run/mpd/socket"
    local command="$1"
    echo -ne "$command\n" | socat - UNIX-CONNECT:"$MPDSOCK"
}

ampm() {
    local ts="$1"
#    date -d "$ts" "+%b %d %I:%M %P"      # Apr 20 04:20 pm
    date -d "$ts" "+%b %d %l:%M %P"       # Apr 20 4:20 pm
}


sec2sex() {
  [[ "$1" = -z ]] && local zeropad=1 && shift
  local h m s
  local input="${1%.*}"
  local dec="${1#*.}"; dec="${dec:0:1}"
  (( dec > 4 )) && ((input++))

  h=$(( input / 3600 ))
  m=$(( (input % 3600) / 60 ))
  s=$(( input % 60 ))

  if (( h > 0 )); then
    printf "%02d:%02d:%02d" "$h" "$m" "$s"
  elif (( zeropad )); then
    printf "%02d:%02d" "$m" "$s"
  else
    printf "%d:%02d" "$m" "$s"
  fi
}



printmpcjson() {
echo -ne "${name:+Name: $name\n}"
echo -ne "${artist:+Artist: $artist\n}"
echo -ne "${album:+Album: $album\n}"
echo -ne "${albumartist:+Album Artist: $albumartist\n}"
echo -ne "${comment:+Comment: $comment\n}"
echo -ne "${composer:+Composer: $composer\n}"
echo -ne "${date:+Date: $date\n}"
echo -ne "${originaldate:+Original Date: $originaldate\n}"
echo -ne "${disc:+Disc: $disc\n}"
echo -ne "${genre:+Genre: $genre\n}"
echo -ne "${performer:+Performer: $performer\n}"
echo -ne "${title:+Title: $title\n}"
echo -ne "${track:+Track: $track\n}"
echo -ne "${time:+Time: $time\n}"
echo -ne "${file:+File: $file\n}"
echo -ne "${state:+State: $state\n}"
echo -ne "${volume:+Volume: $volume\n}"
echo -ne "${repeat:+Repeat: $repeat\n}"
echo -ne "${random:+Random: $random\n}"
echo -ne "${single:+Single: $single\n}"
echo -ne "${consume:+Consume: $consume\n}"
}


logsong() {
   i=$(date "+%b %d %H:%M : player: $1 ")
   j=$(mpc current -f %file%)
   printf '%s\"%s\"\n' "$i" "$j" | cat >> "$mpdlog"
}


sendRootAction(){
  echo "<script>
    function sendRootAction(action) {
      console.log('line 494 sendRootAction() called with action:', action);   // <- add this line
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/?action=' + action, true);  // force the root CGI
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          location.reload();
        }
      };
    xhr.send();
    }
    </script>
    "
}
sendAction(){
  echo "<script>
       function sendAction(action) {
         console.log('navbuttons sendAction() called with action:', action);   // <- add this line
         var xhr = new XMLHttpRequest();
         xhr.open('GET', '?action=' + action, true);
         xhr.onreadystatechange = function () {
           if (xhr.readyState == 4 && xhr.status == 200) {
              location.reload();
           }
         };
         xhr.send();
       }
      </script>"
}

autorefresh(){
  [[ "$state" == play* ]] || return
  cat <<'EOF'
  <script>
  // Auto-refresh every 30s when tab is visible
  setInterval(function() {
    if (!document.hidden) location.reload();
  }, 60000);

  // Refresh immediately when tab becomes visible
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) location.reload();
  });
  </script>
EOF
}

sserefresh(){
  cat << 'EOF'
  <script>
  const evtSource = new EventSource("sse.cgi");

  evtSource.onmessage = function(e) {
    console.log("MPD changed:", e.data);
    // Only refresh if tab is visible
    if (!document.hidden) location.reload();
  };
  </script>
EOF
}


sserefresh(){
  cat <<'EOF'
  <script>
  const evtSource = new EventSource("/sse");
  evtSource.onmessage = e => {
    console.log("MPD changed:", e.data);
    if (!document.hidden) location.reload();
  };
  </script>
EOF
}



mpdlog_title(){
## if directly loading the image isnt' working, use base64 encoding:
  # imgdata=$(base64 /var/www/cgi-bin/android-icon-48x48.png)
  # echo "<a class='hidden-link' href='http://iconoclasthero.com:8000'>"
  # echo "<img src='data:image/png;base64,$imgdata' style='display:inline; vertical-align:top;'>"
  # echo "<h1 style='display: inline; vertical-align: bottom;'>  mpd  </h1></a><hr>"

  printf "<a class='hidden-link' href='http://iconoclasthero.com:8000'>"
#  printf "<img src='/android-icon-48x48.png' style='display: inline; vertical-align: top;'>"
  printf "<img src='/android-icon-96x96.png' style='display: inline; vertical-align: top;'>"
  printf "<h1 style='display: inline; vertical-align: bottom;'></a>"
  printf "&nbsp;&nbsp;<a class='hidden-link' href='/'>mpdlog</a></h1><hr>"
}


navbuttons() {
  echo "<hr>"
  echo "<div class='button-container'>"
  echo "<div class='button-row'>"
  echo "<form id='controlForm'>"
  echo "<h5 style='margin-bottom: 10-px;'>MPD controls:</h5>"
  echo "<button type='button' onclick='sendAction(\"toggle_playback\")' class='btn btn-primary' title='Toggle playback'>‚èØÔ∏è "
  echo "</button>"
  echo "<button type='button' onclick='sendAction(\"next_track\")' class='btn btn-primary' title='Next track'>‚è≠Ô∏è "
  echo "</button>"
  if [[ "$random" = '‚ùå' ]]; then
    echo "<button type='button' onclick='sendAction(\"enable_random\")' class='btn btn-info' title='Enable random'>‚úÖ üîÄ"
    echo "</button>"
  else
    echo "<button type='button' onclick='sendAction(\"disable_random\")' class='btn btn-info' title='Disable random'>‚ùå üîÄ"
    echo "</button>"
  fi
  echo "<button type='button' onclick='sendAction(\"ignore\")' class='btn btn-outline-danger' title='Ignore this item'>üö´"
  echo "</button>"
  echo "</form>"
  echo "</div>"
  echo "<div class='button-row'>"
  echo "<form id='controlForm'>"
  echo "<h5 style='margin-bottom: 10-px;'>Pulseaudio Volume:</h5>"
  echo "<button type='button' onclick='sendAction(\"down_volume\")' class='btn btn-info' title='Volume down'>üîâ"
  echo "</button>"
  echo "<button type='button' onclick='sendAction(\"up_volume\")' class='btn btn-info' title='Volume up'>üîä"
  echo "</button>"
  echo "<button type='button' onclick='sendAction(\"mute_volume\")' class='btn btn-info' title='Mute'>üîá"
  echo "</button>"
  echo "</form>"
  echo "</div>"
  echo "<div class='button-row'>"
  echo "<form id='controlForm'>"
  echo "<h5 style='margin-bottom: 10-px;'>Logs/Song Info:</h5>"

  if [[ "$long" != true ]]; then
    echo "<button type='button' onclick='window.location.href=\"/long\"' class='btn btn-secondary' title='Long log'>üìú"
    echo "</button>" #üïê
  else
    echo "<button type='button' onclick='window.location.href=\"/\"' class='btn btn-danger' title='Return'>‚Ü©Ô∏è "
    echo "</button>"
  fi

  if [[ "$raw" != true ]]; then
    echo "<button type='button' onclick='window.location.href=\"/raw\"' class='btn btn-secondary' title='Raw log'>üìù"
    echo "</button>"
  else
    echo "<button type='button' onclick='window.location.href=\"/\"' class='btn btn-danger' title='Return'>‚Ü©Ô∏è "
    echo "</button>"
  fi

  if [[ "$playing" != true ]]; then
    echo "<button type='button' onclick='window.location.href=\"/playing\"' class='btn btn-secondary' \
          title='Currently playing details'>üéµüí´üé∂"
    echo "</button>" #‚ú®
  else
    echo "<button type='button' onclick='window.location.href=\"/\"' class='btn btn-danger' title='Return'>‚Ü©Ô∏è "
    echo "</button>"
    exit
  fi

  echo "</form>"
  echo "</div>"
  echo "</div>"


###############

}


process_form() {
  if [ "$REQUEST_METHOD" = "GET" ]; then
    query=$(echo "$QUERY_STRING" | tr '&' '\n' | grep -E '^(action=)' | cut -d= -f2)
    (( debug )) && {
                     printf 'start: %s\n' "$FUNCNAME"
                     printf '$REQUEST_URI=%s\n' "$REQUEST_URI"
                     printf '$REQUEST_METHOD=%s\n' "$REQUEST_METHOD"
                     printf '$QUERY_STRING=%s\n' "$QUERY_STRING"
                     printf '$query=%s\n' "$query"
                     printf '\n\n'
                   } >> "$tmplog"

    case "$query" in
      pl_number*)
        plnumber="${query#*:}"
        (( debug )) && printf '$plnumber=$s\n' "$plnumber" >> "$tmplog"
        mpcout=( "$(mpc play "$plnumber")" )
        printf %s\\n "$mpcout[@]}" >> "/tmp/mpd.log"
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      toggle_playback)
        mpc -q toggle
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
          ;;
      next_track)
#        logsong "skipped"
#        mpdcout=( "$(mpdc next 2>&1)" )
#        nextout=( "$(./next -qq 2)" )
        mpc -q next
#        (( debug )) && printf %s\\n "${nextcout[@]}" >> "$tmplog"
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      reset_track)
#        logsong "skipped"
#        mpdcout=( "$(mpdc next 2>&1)" )
#        nextout=( "$(./next -qq 2)" )
        mpc -q seek 0
#        (( debug )) && printf %s\\n "${nextcout[@]}" >> "$tmplog"
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      enable_random)
        mpdcout=( "$(mpdc random\ 1 2>&1)" )
        (( debug )) && printf %s\\n "${mpdcout[@]}" >> "$tmplog"
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      disable_random)
        mpdcout=( "$(mpdc random\ 0 2>&1)" )
        (( debug )) && printf %s\\n "${mpdcout[@]}" >> "$tmplog"
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      ignore)
        ignorecmd=( \mpc -h "$mpdpass"@"$mpchost" addplaylist .mpdignore "$(\mpc -h "$mpdpass@$mpchost" current -f %file%)" )
        "${ignorecmd[@]}" >> /tmp/cgi-debug.log 2>&1
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      up_volume)
        ./pulsevol +5 --no-volstatus --config="mpd-local.conf" >> /tmp/cgi-debug.log 2>&1
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      down_volume)
        ./pulsevol -5 --no-volstatus --config="mpd-local.conf" >> /tmp/cgi-debug.log 2>&1
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
      mute_volume)
        ./pulsevol mute --no-volstatus --config="mpd-local.conf" >> /tmp/cgi-debug.log 2>&1
        echo "Content-type: text/html; charset=UTF-8"
        echo ""
        exit
        ;;
    esac
  fi
}

#nowplaying now_playing
currently_playing(){
#2nd color was #cc0000

  musicdna='<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-2.77 -2.77 33.22 33.22" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"><rect x="-2.77" y="-2.77" width="33.22" height="33.22" rx="16.61" fill="#d94031" strokewidth="0"></rect></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M1.307,9.336c1.28-1.428,3.113-2.248,5.029-2.248c3.065,0,5.655,2.056,6.476,4.86c0.091-0.394,0.2-0.786,0.347-1.174 c0.023-0.086,0.043-0.125,0.063-0.165l0.058-0.145c0.032-0.084,0.064-0.168,0.102-0.25l0.169-0.369 c-1.409-2.536-4.113-4.257-7.214-4.257c-2.342,0-4.582,1.001-6.146,2.747c-0.276,0.309-0.25,0.783,0.058,1.059 C0.557,9.67,1.03,9.647,1.307,9.336z"></path> <path d="M27.426,18.279c-0.308-0.275-0.784-0.25-1.059,0.06c-1.279,1.429-3.113,2.249-5.031,2.249 c-3.064,0-5.655-2.057-6.476-4.859c-0.091,0.395-0.2,0.787-0.348,1.174c-0.023,0.086-0.043,0.125-0.062,0.164l-0.056,0.141 c-0.033,0.085-0.065,0.171-0.104,0.254l-0.168,0.371c1.409,2.535,4.112,4.255,7.213,4.255c2.344,0,4.585-1.002,6.148-2.749 C27.761,19.031,27.736,18.557,27.426,18.279z"></path> <path d="M21.337,7.088c1.916,0,3.749,0.819,5.029,2.248c0.278,0.31,0.751,0.333,1.06,0.058c0.309-0.276,0.334-0.75,0.059-1.059 c-1.564-1.746-3.806-2.747-6.146-2.747c-3.337,0-6.189,2.006-7.488,4.864c-0.004-0.01-0.007-0.021-0.012-0.03 c-0.053,0.115-0.093,0.236-0.141,0.354c-0.018,0.044-0.044,0.084-0.061,0.129l-0.009,0.046c-0.34,0.9-0.54,1.87-0.54,2.888 c0,3.722-3.028,6.749-6.75,6.749c-1.915,0-3.747-0.818-5.026-2.246c-0.278-0.311-0.752-0.334-1.06-0.059 c-0.309,0.277-0.334,0.752-0.058,1.06c1.564,1.744,3.804,2.745,6.144,2.745c3.337,0,6.191-2.006,7.488-4.863 c0.004,0.01,0.007,0.021,0.012,0.03c0.053-0.116,0.094-0.237,0.142-0.356c0.018-0.043,0.043-0.084,0.06-0.127l0.009-0.045 c0.34-0.899,0.54-1.869,0.54-2.888C14.587,10.117,17.616,7.088,21.337,7.088z"></path> <path d="M5.561,12.554c0-1.506-1.332-1.515-1.771-1.975H3.26v4.998c-0.145-0.063-0.309-0.103-0.484-0.103 c-0.562,0-1.016,0.363-1.016,0.812s0.454,0.812,1.015,0.812s1.016-0.363,1.015-0.812v-4.912 C4.338,11.801,5.485,11.647,5.561,12.554z"></path> <path d="M5.576,17.098c0.561,0,1.016-0.363,1.015-0.812v-4.912c0.548,0.427,1.695,0.272,1.771,1.18 c0-1.506-1.332-1.515-1.771-1.975H6.062v4.998c-0.144-0.063-0.308-0.103-0.484-0.103c-0.562,0-1.016,0.363-1.016,0.812 S5.015,17.098,5.576,17.098z"></path> <path d="M8.377,17.098c0.562,0,1.017-0.363,1.016-0.812v-4.912c0.546,0.427,1.695,0.272,1.77,1.18c0-1.506-1.333-1.515-1.77-1.975 h-0.53v4.998c-0.144-0.063-0.308-0.103-0.484-0.103c-0.562,0-1.016,0.363-1.016,0.812S7.816,17.098,8.377,17.098z"></path> <path d="M20.366,12.554c0-1.506-1.332-1.515-1.771-1.975h-0.528v4.998c-0.146-0.063-0.31-0.103-0.483-0.103 c-0.562,0-1.017,0.363-1.017,0.812s0.454,0.812,1.015,0.812s1.016-0.363,1.015-0.812v-4.912 C19.142,11.801,20.291,11.647,20.366,12.554z"></path> <path d="M20.381,17.098c0.562,0,1.017-0.363,1.016-0.812v-4.912c0.548,0.427,1.694,0.272,1.771,1.18 c0-1.506-1.332-1.515-1.771-1.975h-0.529v4.998c-0.145-0.063-0.309-0.103-0.483-0.103c-0.562,0-1.017,0.363-1.017,0.812 S19.821,17.098,20.381,17.098z"></path> <path d="M23.181,17.098c0.562,0,1.018-0.363,1.017-0.812v-4.912c0.547,0.427,1.694,0.272,1.77,1.18 c0-1.506-1.332-1.515-1.77-1.975h-0.53v4.998c-0.144-0.063-0.308-0.103-0.484-0.103c-0.562,0-1.016,0.363-1.016,0.812 S22.622,17.098,23.181,17.098z"></path> </g> </g> </g></svg>'

  musicnote='<svg height="200px" width="200px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-2.18 -2.18 26.16 26.16" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"><rect x="-2.18" y="-2.18" width="26.16" height="26.16" rx="13.08" fill="#e00000" strokewidth="0"></rect></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path style="fill:#000000;" d="M10.653,8.76l8.145-1.321v11.043c0,0.914-0.681,1.644-1.744,1.913 c-1.168,0.289-2.294-0.2-2.519-1.095c-0.224-0.897,0.541-1.858,1.708-2.15c0.527-0.13,1.047-0.103,1.481,0.05v-6.654l-5.969,1.092 l-0.028,8.276c-0.005,0.783-0.713,1.554-1.729,1.805c-1.153,0.289-2.363-0.26-2.492-1.081c-0.221-0.886,0.534-1.837,1.691-2.127 c0.52-0.13,1.029-0.104,1.456,0.046V8.76z M7.591,12.81L7.62,2.581c0,0,2.228-0.119,4.407,3.298c0,0,0.006-1.764-1.669-3.055 C7.087,0.54,7.096,0,7.096,0C6.472,0.073,6.408,0.547,6.408,0.547v10.771c-0.468-0.164-1.028-0.193-1.602-0.05 c-1.27,0.314-2.1,1.363-1.857,2.338c0.143,0.901,1.471,1.506,2.74,1.187c1.115-0.278,1.894-1.12,1.9-1.983H7.591z M13.515,6.2 c0.388-0.097,0.659-0.39,0.661-0.69h0.001l0.01-3.559c0,0,0.775-0.041,1.533,1.148c0,0,0.001-0.614-0.582-1.062 C14,1.242,14.004,1.054,14.004,1.054c-0.217,0.025-0.24,0.19-0.24,0.19v3.748c-0.162-0.058-0.356-0.068-0.556-0.019 c-0.443,0.109-0.73,0.475-0.646,0.814C12.612,6.101,13.074,6.311,13.515,6.2z M17.355,6.209c0.27-0.067,0.458-0.272,0.46-0.481 l0.007-2.479c0,0,0.54-0.029,1.068,0.799c0,0,0.001-0.428-0.404-0.74c-0.793-0.554-0.791-0.685-0.791-0.685 c-0.151,0.018-0.167,0.133-0.167,0.133v2.611c-0.113-0.04-0.249-0.047-0.388-0.012c-0.308,0.076-0.509,0.33-0.45,0.566 C16.724,6.14,17.046,6.287,17.355,6.209z"></path> </g> </g></svg>'





#   current_json=$(mpd-current-json)

#          state=$(echo "$current_json" | jq -r '.status.state'             )
#  song_position=$(echo "$current_json" | jq -r '.status.song_position'     )
#    song_length=$(echo "$current_json" | jq -r '.status.playlist_length'   )
#        elapsed=$(echo "$current_json" | jq -r '.status.elapsed'           )
#     total_time=$(echo "$current_json" | jq -r '.status.duration'          )
#   percent_time=$(echo "$current_json" | jq -r '.status.elapsed_percent'   )
#          title=$(echo "$current_json" | jq -r '.tags.title'               )
#         artist=$(echo "$current_json" | jq -r '.tags.artist'              )
#          album=$(echo "$current_json" | jq -r '.tags.album'               )
#           year=$(echo "$current_json" | jq -r '.tags.date'                )
#         volume=$(echo "$current_json" | jq -r '.status.volume'            )
#         repeat=$(echo "$current_json" | jq -r '.status.repeat'            )
#         single=$(echo "$current_json" | jq -r '.status.single'            )
#         random=$(echo "$current_json" | jq -r '.status.random'            )
#        consume=$(echo "$current_json" | jq -r '.status.consume'           )
##      filepath=$(echo "$current_json" | jq -r '.filename'                 )
#       songpath=$(echo "$current_json" | jq -r '.filename'                 )
#      mbtrackid=$(echo "$current_json" | jq -r '.tags.musicbrainz_trackid' )
#      mbalbumid=$(echo "$current_json" | jq -r '.tags.musicbrainz_albumid' )
#     mbartistid=$(echo "$current_json" | jq -r '.tags.musicbrainz_artistid')
#  [[ "$repeat"  = true ]] && repeat="<span class='song'>‚ü≥$nbsp</span>" || repeat='‚ü≥'
#  [[ "$consume" = true ]] && consume="‚úÖ" || consume="‚ùå"
#  [[ "$random"  = true ]] && random="‚úÖ" || random="‚ùå"
#  [[ "$single"  = true ]] && single="‚úÖ" || unset single

  source <(./mpd-current.py)
  songpath="$filepath"
  state="$u_state"
#  [[ "$state" = play ]] && state=playing
#  [[ "$state" = pause ]] && state=paused

#  [[ "$repeat" = ?[37m‚ü≥?[0m? ]] && repeat='‚ü≥'
#  [[ "$repeat" = ?[1m?[32m‚ü≥?[0m ]] && repeat="<span class='song'>‚ü≥&nbsp</span>"
(( u_repeat )) && repeat="<span class='playing'>‚ü≥$nbsp</span>" || repeat='‚ü≥'

# Set the color class depending on state
[[ "$state" = play ]] && state=playing && colorclass='playing' && altclass='artist' && toggle='‚ñÆ‚ñÆ'
[[ "$state" = pause ]] && state=paused && colorclass='artist' && altclass='playing' && toggle='‚ñ∂'

# Output state + toggle
echo "<strong class='$colorclass'>&nbsp;"
echo "<span class='notes'>‚ô™ ‚ô´</span>"
#echo "&nbsp;"
echo "  $state "
echo "<span class='notes'>‚ô´ ‚ô™</span>"
echo "&nbsp;&nbsp;"
echo "</strong>"
echo "<a class='pauseicon' href='javascript:sendAction(\"toggle_playback\")'><span class='$altclass'>$toggle</span></a>"
echo "&nbsp;"

# Single span wrapping playlist info + skipend
#echo "<span class='$colorclass'>"
echo "<a class='$colorclass' href='/playlist_current' title='Playlist|current song'>#$song_position/$song_length</a>"
echo "&nbsp;"
echo "<a class='skipend' href='javascript:sendAction(\"next_track\")'><span class='ts'>‚ñ∂‚ñÆ</span></a>"
echo "</span><br>"




  echo "<span class='time'><a href='javascript:sendAction(\"reset_track\")' title='Restart track'>elapsed $(sec2sex $elapsed)/$(sec2sex $total_time) (${percent_time%.*}%)</a></span><br>"
  echo "<strong class='song'><a class='hidden-link' href='https://musicbrainz.org/track/$mbtrackid' target='_blank'>$title</a></strong><br>"
  echo "<span class='artist'><strong><a href='https://musicbrainz.org/artist/$mbartistid'' target='_blank'>$artist</a></strong></span><br>"
  year="${year%%-*}"
  echo "<span class='album'><strong><a href='https://musicbrainz.org/release/$mbalbumid'' target='_blank'> ${album% (mp3)}</a> ${year:+(${year})} <a href='/playlist_album' title='Playlist|album'><i class='bi bi-box-arrow-up-right extlink'></i></a></strong></span><br>"

  # Output volume and playback status
  echo "<span class='album'><a href='javascript:sendAction(\"mute_volume\")'>volume</a>: $volume%&nbsp "
  echo "${repeat:+$repeat}$nbsp</span>"
  echo "<span class='album'> ${single:+single: $single}"
  echo "<a href='javascript:sendAction(\"enable_random\")'>${random:+random</a>: $random}&nbsp"
  echo "${consume:+consume: $consume}<br>  </span><hr>"

  album_art_base64=$(mpc -q readpicture "$songpath" 2>/dev/null | base64)
  [[ ! "$album_art_base64" ]] && album_art_stderr=$(mpc -q readpicture "$songpath" 2>&1 >/dev/null)

  if [[ "$album_art_base64" && ! "$album_art_stderr" =~ ^No\ data ]]; then
     echo "<img src='data:image/jpeg;base64,$album_art_base64' alt='Album Art' style='max-width: 30%; height: auto;' />"
  elif [[ -f "${rootcover:=${songpath%%/*}/cover.png}" ]]; then
    album_art_base64="$(base64 < "$rootcover")"
    echo "<img src='data:image/jpeg;base64,$album_art_base64' alt='Album Art' style='max-width: 30%; height: auto;' />"
  elif [[ "$album_art_stderr" =~ ^No\ data ]]; then
    if [[ "$artist" = *Grateful\ Dead* ]]; then
      echo "<img src='syf-2400x2400.png' alt='Album Art' style='max-width:30%;height:auto;' />"
      echo "<div style='width:25%;height:auto;'>Steal Your Face</div><br>"
      echo "<p>mpd returned 'No data'</p>"
    else
      echo "<div style='width: 25%; height: auto;'>$musicdna</div><br>"
      echo '<p>mpd returned "No data"</p>'
     fi
  else
    echo "<div style='width: 25%; height: auto;'>$musicdna</div><br>"
    echo "<p>No album art available</p>"
  fi

  echo "<hr>"

}


next_track(){
  printf '<span class="time">\n'
  printf '<strong><em>\n'
  printf "‚ú® <a href='javascript:sendAction(\"next_track\")' title='Play next song'>Next in queue</a> ‚ú®"
  printf '</em></strong>&nbsp;'
  printf "<a href='/playlist_current' title='Playlist|current song'><i class='bi bi-box-arrow-up-right extlink'>"
  printf '</i></a>\n'
  printf '</span>\n'
  printf '<br>\n'
  printf '<span class="song">\n'
  printf '<strong><em>\n'
  printf '(%02d-%02d) %s - %s\n' "$next_disc" "$next_track" "$next_title" "$(sec2sex -z "$next_time")"
  printf '</em></strong>\n'
  printf '</span>\n'
  printf '<br>\n'
  printf "<span class='artist'><strong><em>%s</em></strong></span><br>" "$next_artist"
  printf "<span class='album'><strong><em>%s</em></strong></span><br>" "$next_album"
}


## flags
[[ "$1" == @(--edit|e|-e) ]] && editscript
[[ "$1" == "--long" ]] && long=true
[[ "$1" == "--raw" ]] && raw=true
[[ "$1" == "--playing" ]] && playing=true
[[ "$1" == "--playlist_album" ]] && playlist_album=1
[[ "$1" == "--playlist_current" ]] && playlist_current=1
[[ "$1" = "--sse-port" ]] && (( "$2" )) && { mpdsseport="$2"; shift 2; continue; }

## endpoints
[[ "$REQUEST_URI" = '/long' ]] && long=true
[[ "$REQUEST_URI" = '/raw' ]] && raw=true
[[ "$REQUEST_URI" = '/playing' ]] && playing=true
[[ "$REQUEST_URI" = '/playlist_album' ]] && playlist_album=1
[[ "$REQUEST_URI" = '/playlist_current' ]] && playlist_current=1

startmpdsse &

process_form

#echo "Content-type: text/html; charset=UTF-8"
#echo ""
#echo "<html><head><title>mpd played</title>"
#printf '<!-- high-res webapp icon -->\n'
#printf '<link rel="icon" type="image/png" sizes="314x314" href="webapp-icon.png">\n'
#printf '<!-- optional fallback for 32x32 or older browsers -->\n'
#printf '<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">\n'
#printf '<!-- legacy fallback -->\n'
#printf '<link rel="icon" href="favicon.ico" type="image/x-icon">\n'
#echo "<link rel="icon" href="favicon.ico" type="image/x-icon">"
#echo "<meta name='viewport' content='width=device-width, initial-scale=1'>"
#echo "<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css'>"
#echo "<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css'>"
#printf '<!-- high-res webapp icon -->\n'
#printf '<link rel="icon" type="image/png" sizes="314x314" href="webapp-icon.png">\n'
#printf '<!-- optional fallback for 32x32 or older browsers -->\n'
#printf '<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">\n'



printf 'Content-type: text/html; charset=UTF-8\n\n'

printf '<html><head><title>mpd played</title>\n'

printf '<link rel="manifest" href="/manifest.json">\n'
printf '<!-- high-res webapp icon -->\n'
printf '<link rel="icon" type="image/png" sizes="314x314" href="/webapp-icon.png">\n'
printf '<!-- optional fallback for 32x32 -->\n'
printf '<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">\n'
printf '<!-- legacy fallback -->\n'
printf '<link rel="icon" href="/favicon.ico" type="image/x-icon">\n'

# viewport & CSS
printf '<meta name="viewport" content="width=device-width, initial-scale=1">\n'
printf '<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">\n'
printf '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">\n'






#mpcjson=$(mpd-current-json)
#
## this also works but is a security issue
##eval "$(jq -r '.metadata | to_entries[] | "\(.key)=\(.value | @sh)"' <<< "$mpcjson")"
##eval "$(jq -r '.status | to_entries[] | "\(.key)=\(.value | @sh)"' <<< "$mpcjson")"
#
#while IFS= read -r line; do
#    IFS='=' read -r key value <<< "$line"
#    declare "$key=$value"
#done < <(jq -r '.tags | to_entries[] | "\(.key)=\(.value)"' <<< "$mpcjson")
#
#while IFS= read -r line; do
#    IFS='=' read -r key value <<< "$line"
#    declare "$key=$value"
#done < <(jq -r '.status | to_entries[] | "\(.key)=\(.value)"' <<< "$mpcjson")

#source <(./mpd-current.py)
source <(./mpd-current -p)
state="$u_state"

    [[ "$repeat" = true ]] && repeat="<span class='song'>‚ü≥$nbsp</span>" || repeat='‚ü≥'
    (( u_repeat )) && repeat="<span class='song'>‚ü≥$nbsp</span>" || repeat='‚ü≥'

#    [[ "$consume" = true ]] && consume="‚úÖ" || consume="‚ùå"
#    [[ "$random" = true ]] && random="‚úÖ" || random="‚ùå"
#    [[ "$single" = true ]] && single="‚úÖ" || unset single


if [[ "$state" = playing && "$long" != true ]]; then
  echo "<met#80cbc4a http-equiv='refresh' content='45'>"
fi


 echo "<style>"
 echo "/* Dark theme colors only */"
 echo ":root {"
#echo "    --bg-color: #121212;"
 echo "    --bg-color: #1e2122;"
 echo "    --text-color: #e0e0e0;"
 echo "    --pre-bg-color: #1e1e1e;"
 echo "    --pre-text-color: #e0e0e0;"
 echo "    --timestamp-color: #80cbc4;"
#echo "    --song-color: #81c784;"
 echo "    --song-color: #cfcd15;"
#echo "    --artist-color: #e57373;"
#echo "    --artist-color: #d94031;"
 echo "    --artist-color: #ff1900;"
 echo "    --green-coloe: #3ea3a3;"
printf '    --playing-color: #3ea3a3;\n'
printf '    --playing-color: #00A000;\n'
echo '    --album-color: #e4dbd3;\n'
#echo "    --album-color: #b0bec5;"
#echo "    --album-color: #912715;"
echo "    --button-bg-color: #333;"
echo "    --button-text-color: #fff;"
echo "}"
echo ""
echo "body { font-family: Arial, sans-serif; background-color: #1e2122; color: #333; padding: 20px; }"
echo "h1 { color: #444; }"
echo "pre { background-color: 383838; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; line-height: 1.5; }"
echo "h2, h3 { margin: 0; padding: 0; }"
#echo ".timestamp { color: #007bff; }"
 echo ".timestamp { color: #80cbc4; }"
echo ".time { color: #007bff; }"
#echo ".song { color: #28a745; }"
echo ".song { color: #facc15; }"
#echo ".artist { color: #dc3545; }"
echo ".artist { color: #d94031; }"
echo ".artist { color: #d73e30; }"
 printf '.path { color: #5e5b55; }      \n'
 printf '.album { color: #6c757d; }     \n'
 printf '.bullet-1 { color: #76726a; }   \n'
 printf '.pl-head { color: #cbc4b7; }    \n'
 printf '.pauseicon { font-style: normal;      \n' #  /* remove italics */
#printf '             line-height: 1.2em;      \n'
 printf '             color: #d94031;          \n' #  /* red color */
 printf '             letter-spacing: -0.05em; \n' #  /* optional: tighten spacing for the pause bars */
 printf '           }                          \n'
#printf '@media (max-width: 768px) { \n'
#printf '    .pauseicon { \n'
#printf '        letter-spacing: -0.5em;  /* tighter spacing for small screens */ } \n'
#printf ' }\n'

#* Mobile only: replace ‚ñÆ‚ñÆ with emoji */
printf '@media (max-width: 768px) {  \n'
printf '    .pauseicon {           \n'
printf '        visibility: hidden;  \n'
printf '        position: relative;  \n'
#printf '        font-size: 0.8em;  /* shrink the character */ \n'
printf '        font-size: 1.2em;  /* shrink the character */ \n'
#printf '        letter-spacing: -0.5em; \n'
#printf '        transform: scaleY(2.02);  /* 60% of original height */ \n'
#printf '        line-height: 2.2em;  /* shrink vertical height */ \n'
printf '    }                         \n'
 printf '    .pauseicon::after {      \n'
#printf '       content: "‚ñÆ‚ñÆ";        \n'
 printf '        content: "‚èØ";        \n'
 printf '        visibility: visible; \n'
 printf '        position: absolute;  \n'
 printf '        left: 0; }           \n'
 printf '}                            \n'




printf '.skipend { line-height: 1.2em;       \n'
printf '           position: absolute;       \n'
printf '           font-style: normal; }     \n'
printf '@media (max-width: 768px) {          \n'
printf '    .skipend { visibility: hidden;   \n'
printf '               font-style: normal;   \n'
printf '               font-size: 1.2em;     \n'
printf '               position: relative; } \n'
printf '    .skipend::after { content: "‚è≠";  \n'
printf '        visibility: visible;         \n'
printf '        position: absolute;          \n'
printf '        left: 0; }                   \n'
printf ' }                                   \n'






printf '.notes { letter-spacing: -0.15em;   /* tighten the music notes */ \n'
printf '         font-kerning: none;        /* optional: turn off font kerning */ }\n'
#printf '.playing { color: #3ea3a3; }\n'
#printf '.playing { color: #00A000; }\n'
#printf '.playing { color: #007A33; }\n'
printf '.playing { color: #00A000; }\n'
#printf '.playing { color: #00C000; }\n'
#printf '.playing { color: #007A33; }\n'
#printf '.playing { color: #00875A; }\n'
printf '.album { color: #e4dbd3; }\n'
#echo ".album { color: #912715; }"
#echo ".song a, .album a { color: inherit; text-decoration: underline; }"
echo ".song a, .album a, .artist a { color: inherit; font-style: italic; }"
#echo ".song a:hover, .album a:hover, .artist a:hover {text-decoration: underline; }"
echo ".watermark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('$cover'); opacity: 0.1; pointer-events: none; }"
echo ".tab-stops { tab-size: 8; -moz-tab-size: 8; -o-tab-size: 8; }"
#echo ".watermark {"
#echo "    width: 100%;"
#echo "    height: 100%;"
#echo "    position: fixed;"
#echo "    top: 0;"
#echo "    left: 0;"
#echo "    background-size: cover;"
#echo "    background-image: url('data:image/jpeg;base64,$album_art_base64');"
#echo "    opacity: 0.5;"
#echo "    z-index: -1;"
#echo "}"

echo ".pre-alternate:nth-child(odd) { color: #ff0000; }"  # Alternate color for odd in raw output
echo ".button-container { display: flex; flex-direction: column; gap: 10px; }"  # Change to column layout
echo ".button-row { display: flex; gap: 10px; }"
echo ".extlink { font-size:0.6em; vertical-align:super; }" # little box with arrow pointing top right, superscript, smaller.

echo "</style>"

## define javascript functions
sendAction
sendRootAction

echo "</head>"
echo "<body>"
autorefresh
sserefresh



if [[ "$raw" = true ]]; then
  mpdlog_title
  currently_playing
  tail1=2000 && tail2=250
  logsize=$(stat -c %s "${mpdlogfile[@]}")
  (( logsize < 300000 )) && mpdlogfile=( /var/log/mpd/mpd.log.1 /var/log/mpd/mpd.log )
  echo "<pre>"
  while read -r i; do
    unset skipored
    i=$(echo "$i" |sed 's/ : player//')
    [[ "$i" = @(*\:\ skipped\ *|*\:\ ignored\ *) ]] && skipored=true
    echo "<span class='pre-alternate'>${skipored:+<s>}$i${skipored:+</s>}</span>"
  done < <(cat "${mpdlogfile[@]}" | tail -n "${tail1}" | grep player\:\ |grep -v stored_playlist | tail -n "${tail2}" | tac)
  echo "</pre>"

  navbuttons

  echo "</body>"
  exit 0


elif (( playlist_album )); then
  mpdlog_title
  currently_playing
  next_track
  printf '<hr>\n'
  # grab playlist info with positions
  readarray -t playlist_array < <(
    \mpc playlist -f '%position%‚ò¢%artist%‚ò¢%title%‚ò¢%albumartist%%album%‚ò¢%disc%‚ò¢%track%‚ò¢%time%' |
    grep -F "$album_artist$album"
  )
  echo "<div class='playlist-album'>"
#  printf '<h3 class="pl-head">Songs in playlist from <em class="album">%s:</em></h3>\n' "$album"
printf '<h3 class="pl-head">Songs in playlist from <em class="album">\n'
printf '<a href="https://musicbrainz.org/release/%s" style="text-decoration:none;color:inherit;" target="_blank" rel="noopener" title="Open release in MusicBrainz">%s</a></em>:</h3>\n' "$mbalbumid" "$album"
  printf '<span class="path">Path: %s</span><br>\n' "${filepath%\/*}"
  printf '<br>\n'

  echo "<ul>"

  for entry in "${playlist_array[@]}"; do
    IFS='‚ò¢' read -r pl_pos pl_artist pl_title pl_albuminfo pl_dd pl_tt pl_tracktime <<< "$entry"

    # Use text link instead of button
    printf '<li>'
    (( pl_pos == song_position )) && printf "<span class='artist'>"
    printf "<a href='javascript:sendRootAction(\"pl_number:%s\")' title='Play %s'>" "$pl_pos" "$pl_pos"
    printf '<strong>%s</strong> ‚Äì %.02d-%.02d - %s [%s]' "$pl_artist" "$pl_dd" "$pl_tt" "$pl_title" "$pl_tracktime"
    (( pl_pos == song_position )) && printf "</span>"
    printf '</a></li>\n'
  done

  printf '<br>\n'
  echo "</ul>"
  echo "</div>"
  printf '<hr style="border:none; height:2px; background-color:currentColor;" class="artist">\n'
  navbuttons
  echo "</body>"
  exit 0

elif (( playlist_current )); then
  mpdlog_title
  currently_playing
  next_track

  # grab playlist info with positions
  readarray -t playlist_array < <(
    \mpc playlist -f '%position%‚ò¢%albumartist%‚ò¢%artist%‚ò¢%title%‚ò¢%album%‚ò¢%disc%‚ò¢%track%‚ò¢%time%' |
       grep -C 12 -E ^"${song_position}‚ò¢"
  )
  printf '<hr>\n'
  printf '<div class="playlist-album">\n'
  printf '<h3 class="pl-head">Playlist @ current song:<br></h3><br>\n' #&nbsp;&nbsp;<em>%s ‚Äì "%s:"</em></h3>\n' "$artist" "$title"
  printf '<ul>\n'

  printf '<ul>\n'  # start the outer list
  last_pl_album=''
  for entry in "${playlist_array[@]}"; do
    IFS='‚ò¢' read -r pl_pos pl_album_artist pl_artist pl_title pl_album pl_dd pl_tt pl_tracktime <<< "$entry"

    if [[ "$pl_album" != "$last_pl_album" ]]; then
      # Close the previous album‚Äôs <ul> if one was open
      [[ -n "$last_pl_album" ]] && printf '</ul></li>\n'
      # Start a new parent <li> for the album
      printf '<li style="color:#cbc4b7"><strong class="bullet-1">%s -- %s</strong>\n' "$pl_album_artist" "$pl_album"
      printf '<ul>\n'
    fi

    # Each song = demoted <li>
    printf '<li>'
    (( song_position == pl_pos )) && printf '<span class="artist">'
    printf "<a href='javascript:sendRootAction(\"pl_number:%s\")' title='Play %s'>" "$pl_pos" "$pl_pos"
    printf '<strong>%s</strong> ‚Äì %.02d-%.02d - %s [%s]' \
      "$pl_artist" "$pl_dd" "$pl_tt" "$pl_title" "$pl_tracktime"
    (( song_position == pl_pos )) && printf '</span>'
    printf '</a></li>\n'

    last_pl_album="$pl_album"
  done
  # Close any remaining lists
  [[ -n "$last_pl_album" ]] && printf '</ul></li>\n'
  printf '</ul>\n'

  echo "</ul>"
  echo "</div>"
  navbuttons
  echo "</body>"
  exit 0

elif [[ "$playing" = true ]]; then
  mpdlog_title
  currently_playing
# echo "<pre>"
#  while read -r i; do
#    echo "$i"
#  done < <(mpd-current-json)
  json_output=$(mpd-current-json)
#  echo "$json_output"
#  echo "</pre>"

  echo "<div class='currently-playing'>"
  echo "  <h3>Currently Playing:</h3>"

  # Parse and display status section
  echo "  <div class='status'>"
  echo "    <h4>Status:</h4>"
  echo "    <ul>"
  echo "$json_output" | jq -r '.status | to_entries[] | "      <li>\(.key): \(.value)</li>"'
  echo "    </ul>"
  echo "  </div>"

  # Parse and display tags section
  echo "  <div class='tags'>"
  echo "    <h4>Tags:</h4>"
  echo "    <ul>"
  echo "$json_output" | jq -r '.tags | to_entries[] | "      <li>\(.key): \(.value)</li>"'
  echo "    </ul>"
  echo "  </div>"

  echo "</div>"
  echo "<hr>"

  navbuttons
  echo "</body>"
  exit 0

fi

# Add watermark div
#echo "<div class='watermark'></div>"
#echo "<div class='watermark' style='background-image: url(\"$cover\");'></div>"

mpdlog_title

#baseline: Aligns the baseline of the element with the baseline of the parent element.
#top: Aligns the top of the element with the top of the tallest element in the line.
#bottom: Aligns the bottom of the element with the lowest element in the line.
#text-top: Aligns the top of the element with the top of the parent element's font.
#text-bottom: Aligns the bottom of the element with the bottom of the parent element's font.
#sub: Aligns the baseline of the element with the subscript baseline of the parent element.
#super: Aligns the baseline of the element with the superscript baseline of the parent element.

currently_playing

next_track

printf '<hr style="background-color:#912715">\n'
printf "<strong class='time'>ü™µ of previous songs:</strong><br>"
printf "<br>"

#tail1=500; tail2=12
tail1=500; tail2=24

if "${long}"; then
  tail1=20000 && tail2=250;
  logsize=$(stat -c %s "${mpdlogfile[@]}")
  (( logsize < 300000 )) && mpdlogfile=( /var/log/mpd/mpd.log.1 /var/log/mpd/mpd.log )
else
  logsize=$(stat -c %s "${mpdlogfile[@]}")
  (( logsize < 30000 )) && mpdlogfile=( /var/log/mpd/mpd.log.1 /var/log/mpd/mpd.log )
fi 2>/dev/null

while read -r i; do
  unset artist action # timestamp songpath qsongpath song duration album disc track ddtt
  timestamp="${i%% : *}"; timestamp=$(ampm "$timestamp")
  action="${i#*player: }"; action="${action%% *}"
  songpath="${i%\"*}"; qsongpath="\"$songpath"; songpath="${songpath#*\"}"
  song=$(basename "$songpath"); song="${song%.*}"

  duration=$(mediainfo --Inform="General;%Duration/String3%" "/library/music/$songpath")
  duration="${duration#*:}"; duration="${duration%.*}"

#######  Method B: this takes a ton of time!!!
#######  duration=$(mpc --format %time% search filename "$songpath")

#######  Method C: this does not work when songpath contains special characters, but it works otherwise:
#######  duration=$(mpdc find\ \"\(File\ ==\ \\\""$songpath"\\\"\)\"|grep duration)

  if [[ "$song" =~ .+\ --\ (([[:digit:]]{1,3}(-)?)?[[:digit:]]{1,3})\ -\ .+ ]]; then
    artist="${song%% -- *}"
    ddtt="${song%% - *}"; ddtt="${ddtt##* -- }"
    unset disc track
    [[ "$ddtt" = *-* ]] && disc="${ddtt%-*}" && track="${ddtt#*-}" || track="$ddtt"
    song="${song#* - }"
  elif [[ "$song" =~ (([[:digit:]]{1,3}(-)?)?[[:digit:]]{1,3})\ -\ .+\ --\ .+ ]]; then
    artist="${song%% -- *}"; artist="${artist#* - }"
    ddtt="${song% - *}"
    unset disc track
    [[ "$ddtt" = *-* ]] && disc="${ddtt%-*}" && track="${ddtt#*-}" || track="$ddtt"
    song="${song#* -- }"
  else
    artist="<strong>The song $song does not fit the RegEx!</strong>"
  fi

  songdir=$(dirname "$songpath")
# artist="${songdir%% -- *}"; artist="${artist##*\/}"
  album="${songdir#* -- }"; album="${album##*\/}"; album="${album% (mp3)}"

  [[ "$action" = @(skipped|ignored) ]] && echo "<s>"
  [[ "$action" = ignored ]] && echo "<i>"
# echo "<strong class='timestamp'>@ $timestamp, $action</span><br>"
# echo "<span class='timestamp'>@ $timestamp, $action</span><br>"
# echo "<span class='song'>($disc-$track) $song - $duration</span><br>"
# echo "<span class='artist'>$artist</span><br>"
# echo "<span class='album'>$album</span><br>"
  echo "<strong class='timestamp'>@ $timestamp, $action      </strong><br>"
  echo "<strong class='song'>($disc-$track) $song - $duration</strong><br>"
  echo "<strong class='artist'>$artist                       </strong><br>"
  echo "<strong class='album'>$album                         </strong><br>"

  if [[ "${long}" = true ]]; then
    echo "<span class='album'>${songpath}</span><br>"
  fi 2>/dev/null

  echo "<br>"

  #echo "<span class='album'>${songpath}</span><br>"

  [[ "$action" = @(skipped|ignored) ]] && echo "</s></i>"

###creating an array may be slightly faster:
#  output=""
#  [[ "$action" = @(skipped|ignored) ]] && output+="<s>"
#  [[ "$action" = ignored ]] && output+="<i>"
#  output+="<strong class='timestamp'>@ $timestamp, $action</strong><br>"
#  output+="<span class='song'>($disc-$track) $song - $duration</span><br>"
#  output+="<span class='artist'>$artist</span><br>"
#  output+="<span class='album'>$album</span><br>"
#
#  if [[ "${long}" = true ]]; then
#    output+="<span class='album'>${songpath}</span><br>"
#  fi
#
#  output+="<br>"
#  [[ "$action" = @(skipped|ignored) ]] && output+="</s></i>"
#
#  echo "$output"




done < <( cat "${mpdlogfile[@]}" |
          tail -n "${tail1}" |
          grep player\:\ |
          tail -n "${tail2}" |
          tac )

navbuttons

echo "</body>"
echo "</html>"

exit

